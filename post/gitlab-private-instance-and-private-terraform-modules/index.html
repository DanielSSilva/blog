<!doctype html><html lang=en-us><head><title>Gitlab private instance and private Terraform modules | Daniel Silva's blog</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="At my current job, we use a private instance of Gitlab to host the code, CI/CD, and such, and we also have private runners. I recently began working on a terraform script that became a module since multiple teams/projects can leverage such implementation. For this reason, it makes sense to have a repository dedicated to this module (or even more modules, but that can be another topic).
The objective üîóThe idea is pretty simple: Have a git repository that hosts the module(s), and every other project that wants to use the them, reference the repository through the source = &#34;git:: (."><meta name=twitter:title content="Gitlab private instance and private Terraform modules &#183; Daniel Silva's blog"><meta name=twitter:image content="https://blog.danielssilva.dev/img/coast.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:creator content="@DanielSilv9"><meta property="twitter:site" content="@DanielSilv9"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta property="og:title" content="Gitlab private instance and private Terraform modules &#183; Daniel Silva's blog"><meta property="og:url" content="https://blog.danielssilva.dev/post/gitlab-private-instance-and-private-terraform-modules/"><meta property="og:image" content="https://blog.danielssilva.dev/img/coast.png"><meta name=generator content="Hugo 0.111.3"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-136825774-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/tags>Tags</a>
<a href=https://www.danielssilva.dev>About</a></nav><main class=main><section id=single><h1 class=title>Gitlab private instance and private Terraform modules</h1><div class=tip><time datetime="2022-07-26 00:00:00 +0000 UTC">Jul 26, 2022</time>
<span class=split>¬∑</span>
<span>622 words</span>
<span class=split>¬∑</span>
<span>3 minute read</span></div><div class=content><p>At my current job, we use a private instance of Gitlab to host the code, CI/CD, and such, and we also have private runners.
I recently began working on a terraform script that became a module since multiple teams/projects can leverage such implementation. For this reason, it makes sense to have a repository dedicated to this module (or even more modules, but that can be another topic).</p><h2 id=the-objective>The objective <a href=#the-objective class=anchor>üîó</a></h2><p>The idea is pretty simple: Have a git repository that hosts the module(s), and every other project that wants to use the them, reference the repository through the <code>source = "git:: (...)</code> terraform syntax.</p><h2 id=using-terraform-modules>Using terraform modules <a href=#using-terraform-modules class=anchor>üîó</a></h2><p>I love Terraform documentation, since it&rsquo;s really well written, has examples and is very detailed. On <a href=https://www.terraform.io/language/modules/sources#module-sources target=_blank rel=noopener>this</a> page, they have examples on how to use modules with different sources. Without going into much details <a href=https://www.terraform.io/language/modules/sources#generic-git-repository target=_blank rel=noopener>here</a> is what we are looking for:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-v data-lang=v><span style=display:flex><span><span style=color:#a2f;font-weight:700>module</span> <span style=color:#b44>&#34;vpc&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#b8860b>source</span> <span style=color:#666>=</span> <span style=color:#b44>&#34;git::https://example.com/vpc.git&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>module</span> <span style=color:#b44>&#34;storage&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#b8860b>source</span> <span style=color:#666>=</span> <span style=color:#b44>&#34;git::ssh://username@example.com/storage.git&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=the-issue>The issue <a href=#the-issue class=anchor>üîó</a></h2><p>Because the module is hosted on a private instance of Gitlab, we need some sort of authentication in order to be able to fetch the code. For a local setup, I&rsquo;ve generated SSH keys and it works perfectly, but for the CI/CD pipeline I haven&rsquo;t figured how to achieve that.</p><h2 id=the-ci_job_token-predefined-variable>The CI_JOB_TOKEN predefined variable <a href=#the-ci_job_token-predefined-variable class=anchor>üîó</a></h2><p><a href=https://docs.gitlab.com/ee/ci/jobs/ci_job_token.html target=_blank rel=noopener>CI_JOB_TOKEN</a> is a predefined variable that gets populated whenever a pipeline job is about to run and serves as an access token.
As they mention on the documentation</p><blockquote><p>You can also use the job token to authenticate and clone a repository from a private project in a CI/CD job:</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.example.com/&lt;namespace&gt;/&lt;project&gt;
</span></span></code></pre></div><p>This gives us an hint that we could use the syntax <code>https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.example.com/&lt;namespace>/&lt;project></code> for our case!
Not so fast! We need to keep in mind that in this case we are not running a command on the pipeline itself. Instead, we are referencing the repository on our <code>main.tf</code> file, which means that the pipeline won&rsquo;t see this, hence it will not replace the variable.</p><h2 id=storing-credentials-and-replacing-the-repository-endpoint>Storing credentials and replacing the repository endpoint <a href=#storing-credentials-and-replacing-the-repository-endpoint class=anchor>üîó</a></h2><p>We can configure the pipeline to store the git credentials, as well as taking care of replacing the URL to something we want.</p><p>Here&rsquo;s a snippet of the configuration that we&rsquo;re currently using:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git config --global credential.helper store
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;https://gitlab-ci-token:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CI_JOB_TOKEN</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>@gitlab.ourinstancename.com&#34;</span> &gt; ~/.git-credentials
</span></span><span style=display:flex><span>git config --global url.<span style=color:#b44>&#34;https://gitlab.ourinstancename.com/&#34;</span>.insteadOf <span style=color:#b44>&#34;git@gitlab.ourinstancename.com:&#34;</span>
</span></span></code></pre></div><p>Here&rsquo;s what it&rsquo;s doing:</p><ol><li>Configure a credential helper to store our credentials - I&rsquo;ve tried with <code>cache</code> instead of <code>store</code> but it didn&rsquo;t work</li><li>store the username (<code>gitlab-ci-token</code> ) and access token (<code>${CI_JOB_TOKEN}</code>)</li><li>Replace the <code>git@</code> syntax with HTTPS, in order to use the user:accessToken</li></ol><h2 id=adding-these-configs-to-the-pipeline>Adding these configs to the pipeline <a href=#adding-these-configs-to-the-pipeline class=anchor>üîó</a></h2><p>Because between stages the runner might change, we need to run <code>terraform init</code> on every stage to ensure we have everything set up, including the modules.
We can use the <code>default</code> YAML element to specify what should run before every job, and include these configurations there. Here&rsquo;s an example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:green;font-weight:700>before_script</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#080;font-style:italic># setup git to download module from another repo</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>git config --global credential.helper store<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>echo &#34;https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ourinstancename.com&#34; &gt; ~/.git-credentials<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>git config --global url.&#34;https://gitlab.ourinstancename.com/&#34;.insteadOf &#34;git@gitlab.ourinstancename.com:&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span><span style=color:#080;font-style:italic># setup terraform variables and init</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>- export ARM_CLIENT_ID=${ARM_CLIENT_ID}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>- export ARM_CLIENT_SECRET=${ARM_CLIENT_SECRET}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>- export ARM_SUBSCRIPTION_ID=${ARM_SUBSCRIPTION_ID}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>- export ARM_TENANT_ID=${ARM_TENANT_ID}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>- export TF_IN_AUTOMATION=1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>- terraform init -input=false<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>			</span>-upgrade<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>			</span>-backend-config=&#34;storage_account_name=stgotham${CI_ENVIRONMENT_NAME}&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>			</span>-backend-config=&#34;container_name=terraform&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>			</span>-backend-config=&#34;key=terraform.tfstate&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>			</span>-backend-config=&#34;subscription_id=${ARM_SUBSCRIPTION_ID}&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>			</span>-backend-config=&#34;tenant_id=${ARM_TENANT_ID}&#34;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>		</span>- terraform workspace select ${CI_ENVIRONMENT_NAME} || terraform workspace new ${CI_ENVIRONMENT_NAME}<span style=color:#bbb>
</span></span></span></code></pre></div><h1 id=wrapping-up>Wrapping up <a href=#wrapping-up class=anchor>üîó</a></h1><p>If you are using terraform and hosting the modules on a private instance of Gitlab, you need to configure the CI/CD pipelines to know how to fetch the code from a private repository.
One approach is using the 3 lines I&rsquo;ve previously mentioned:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git config --global credential.helper store
</span></span><span style=display:flex><span><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;https://gitlab-ci-token:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CI_JOB_TOKEN</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>@gitlab.ourinstancename.com&#34;</span> &gt; ~/.git-credentials
</span></span><span style=display:flex><span>git config --global url.<span style=color:#b44>&#34;https://gitlab.ourinstancename.com/&#34;</span>.insteadOf <span style=color:#b44>&#34;git@gitlab.ourinstancename.com:&#34;</span>
</span></span></code></pre></div><p>Thanks for reading this, and I hope that this was useful!</p></div><div class=tags><a href=https://blog.danielssilva.dev/tags/devops>DevOps</a>
<a href=https://blog.danielssilva.dev/tags/terraform>Terraform</a></div><div id=comments><script>var id=13,commentsDiv;if(id){let t="https://github.com/DanielSSilva/blog/issues/".concat(id),n="https://api.github.com/repos/DanielSSilva/blog/issues/".concat(id,"/comments");commentsDiv=document.getElementById("comments");let e=new XMLHttpRequest;e.responseType="json",e.open("GET",n),e.setRequestHeader("Accept","application/vnd.github.v3.html+json"),e.send(),e.onload=function(){if(e.status!=200){let e=document.createElement("p");e.innerHTML="<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>",commentsDiv.appendChild(e)}else{let n=e.response,s=document.createElement("h2");s.innerHTML="Comments: ".concat(n.length),commentsDiv.appendChild(s);let o=document.createElement("p");o.innerHTML="<i>You can leave a comment using this <a href='".concat(t,"'>GitHub issue</a>.</i>"),commentsDiv.appendChild(o),n.forEach(function(e){let t=document.createElement("div");t.setAttribute("class","gh-comment"),t.innerHTML="".concat("<div class='gh-header'>","<img src='",e.user.avatar_url,"' />","<div style='margin:auto 0;'>","<b><a class='gh-username' href='",e.user.html_url,"'>",e.user.login,"</a></b>"," commented at <em>",new Date(e.created_at),"</em>","</div>","</div>","<div class='gh-body'>",e.body_html,"</div>"),commentsDiv.appendChild(t)})}},e.onerror=function(){let e=document.createElement("p");e.innerHTML="<i>Some error loading comments.</i>",commentsDiv.appendChild(e)}}</script></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/DanielSSilva rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/DanielSilv9 rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>¬© Copyright
2023
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Daniel Silva</div></footer></body></html>