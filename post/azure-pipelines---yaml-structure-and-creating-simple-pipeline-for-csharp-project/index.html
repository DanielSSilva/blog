<!doctype html><html lang=en-us><head><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Azure pipelines - YAML structure and creating simple pipeline for C# project &#183; Daniel Silva's blog"><meta name=twitter:description content="Azure pipelines can be created through a GUI or through a YAML file. I will be focusing on the YAML instead of GUI for three main reasons:
It is being favored over the GUI Allows to commit the YAML to a source control, thus allowing versioning Re-usability (will cover it in another post) Schema of the YAML file üîóMicrosoft docs has an extensive explanation about the schema and everything that is supported."><meta name=twitter:site content="DanielSilv9"><meta name=twitter:creator content="DanielSilv9"><meta name=twitter:image content="/img/coast.jpeg"><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="og:title" content="Azure pipelines - YAML structure and creating simple pipeline for C# project &#183; Daniel Silva's blog"><meta property="og:description" content="Azure pipelines can be created through a GUI or through a YAML file. I will be focusing on the YAML instead of GUI for three main reasons:
It is being favored over the GUI Allows to commit the YAML to a source control, thus allowing versioning Re-usability (will cover it in another post) Schema of the YAML file üîóMicrosoft docs has an extensive explanation about the schema and everything that is supported."><meta property="og:url" content="https://blog.danielssilva.dev/post/azure-pipelines---yaml-structure-and-creating-simple-pipeline-for-csharp-project/"><meta property="og:site_name" content="Daniel Silva's blog"><meta property="og:image" content="/img/coast.jpeg"><meta property="og:image:secure_url" content="/img/coast.jpeg"><meta property="article:published_time" content="2021-07-10T01:00:00Z"><title>Azure pipelines - YAML structure and creating simple pipeline for C# project | Daniel Silva's blog</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Azure pipelines can be created through a GUI or through a YAML file. I will be focusing on the YAML instead of GUI for three main reasons:
It is being favored over the GUI Allows to commit the YAML to a source control, thus allowing versioning Re-usability (will cover it in another post) Schema of the YAML file üîóMicrosoft docs has an extensive explanation about the schema and everything that is supported."><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-136825774-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/tags>Tags</a>
<a href=https://www.danielssilva.dev>About</a></nav><main class=main><section id=single><h1 class=title>Azure pipelines - YAML structure and creating simple pipeline for C# project</h1><div class=tip><time datetime="2021-07-10 01:00:00 +0000 UTC">Jul 10, 2021</time>
<span class=split>¬∑</span>
<span>991 words</span>
<span class=split>¬∑</span>
<span>5 minute read</span></div><div class=content><p>Azure pipelines can be created through a GUI or through a YAML file.
I will be focusing on the YAML instead of GUI for three main reasons:</p><ul><li>It is being favored over the GUI</li><li>Allows to commit the YAML to a source control, thus allowing versioning</li><li>Re-usability (will cover it in another post)</li></ul><h1 id=schema-of-the-yaml-file>Schema of the YAML file <a href=#schema-of-the-yaml-file class=anchor>üîó</a></h1><p><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema" target=_blank rel=noopener>Microsoft docs</a> has an extensive explanation about the schema and everything that is supported.
This is my go-to when I have questions about schema/features.</p><p>Let&rsquo;s start with the concepts.
Here&rsquo;s what I consider to be the &ldquo;basic&rdquo; structure of the YAML file:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:green;font-weight:700>trigger</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>pool</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>jobs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>job</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>task</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>task</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>job</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>task</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>task</span>:<span style=color:#bbb>
</span></span></span></code></pre></div><p>Let&rsquo;s break it down into what each element does:</p><ul><li><em>trigger</em>: as the name implies, here you configure what will trigger your pipeline. The <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema%2Cparameter-schema#triggers" target=_blank rel=noopener>documentation</a> has a lot of information, but in short, there are 4 trigger types: <strong><em>Push</em></strong>, <strong><em>Pull Request</em></strong>, <strong><em>Scheduled</em></strong> and <strong><em>Pipeline</em></strong>. Just this first element itself can be a blog post. For now, we can set this to &ldquo;<strong><em>none</em></strong>&rdquo;, meaning it will never be triggered (but you can call it manually).</li><li><em>pool</em>: Defines on which pool the pipeline should run. You can run on a Microsoft-Hosted pool or on a private pool. For now we will use the Microsoft-hosted pool, but on a future post we will see how to create our own, but if you are really curious, you can check my <a href=https://danielssilva.dev/2020-09-28-Using-Raspberry-Pi-as-an-Azure-Agent-for-Pipelines/ target=_blank rel=noopener>Using RaspberryPi as an Azure agent for Pipelines (Part 1)</a> post.</li><li><em>jobs</em>: The pipeline can have multiple jobs. Unless stated otherwise (by using the dependsOn parameter), jobs run in parallel. Each job has <em>steps</em>, which are defined into one or many <em>tasks</em></li></ul><h1 id=project-structure>Project structure <a href=#project-structure class=anchor>üîó</a></h1><p>For the sake of simplicity, let&rsquo;s say we have a simple C# console application that outputs a greeting message given the user name as a parameter.
You can find this project on my Azure DevOps project repository called <a href=https://dev.azure.com/danielssilvadev/_git/AzDevOpsSeries target=_blank rel=noopener>AzDevOpsSeries</a></p><p>We don&rsquo;t like broken things, so let&rsquo;s add a simple unit test to make sure that the method is returning what&rsquo;s expected.</p><p>The project structure is the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>GreeterProject
</span></span><span style=display:flex><span>|
</span></span><span style=display:flex><span>|-----GreeterApp
</span></span><span style=display:flex><span>|  |
</span></span><span style=display:flex><span>|  |-----GreeterApp.csproj
</span></span><span style=display:flex><span>|
</span></span><span style=display:flex><span>|-----GreeterTests
</span></span><span style=display:flex><span>|  |
</span></span><span style=display:flex><span>|  |-----GreeterTests.csproj
</span></span></code></pre></div><h1 id=creating-our-pipeline>Creating our pipeline <a href=#creating-our-pipeline class=anchor>üîó</a></h1><p>Since we want to keep our pipeline it in source control, let&rsquo;s keep it within our project repository.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>GreeterProject
</span></span><span style=display:flex><span>|
</span></span><span style=display:flex><span>|-----GreeterApp
</span></span><span style=display:flex><span>|  |
</span></span><span style=display:flex><span>|  |-----GreeterApp.csproj
</span></span><span style=display:flex><span>|
</span></span><span style=display:flex><span>|-----GreeterTests
</span></span><span style=display:flex><span>|  |
</span></span><span style=display:flex><span>|  |-----GreeterTests.csproj
</span></span><span style=display:flex><span>|
</span></span><span style=display:flex><span>|-----Pipelines
</span></span><span style=display:flex><span>|  |
</span></span><span style=display:flex><span>|  |-----Greeter.yaml
</span></span></code></pre></div><p>The goal for our pipeline is to restore, build, test and publish our GreeterApp.</p><h2 id=creating-the-yaml-file>Creating the YAML file <a href=#creating-the-yaml-file class=anchor>üîó</a></h2><p>In order to keep this simple, we want to trigger the pipeline manually, and use one of the free Microsoft agents, in this case with Windows.</p><p>This can be achieved with the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:green;font-weight:700>trigger</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span>- none<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>pool</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>vmImage</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;windows-latest&#39;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>In this case, the tasks have dependencies (we don&rsquo;t want to publish without testing, etc), so we will use 1 job with multiple tasks.</p><p>Since we are using .NET, we will use the <code>DotNetCoreCLI@2</code> task.
You can find more info on <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/build/dotnet-core-cli?view=azure-devops" target=_blank rel=noopener>the docs</a>, but here&rsquo;s an example of how we can restore our project:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span>- <span style=color:green;font-weight:700>task</span>:<span style=color:#bbb> </span>DotNetCoreCLI@2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>displayName</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;Restore Greeter Project&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>inputs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>restore <span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>projects</span>:<span style=color:#bbb> </span>GreeterProject/GreeterApp/GreeterApp.csproj <span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>feedsToUse</span>:<span style=color:#bbb> </span>config<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>nugetConfigPath</span>:<span style=color:#bbb> </span>./nuget.config <span style=color:#bbb>
</span></span></span></code></pre></div><ul><li><strong>command</strong>: This is the command that you usually use within dotnet, such as <em>build</em>, <em>test</em>, etc</li><li><strong>projects</strong>: Specify the project, a list of projects or the sln to use (relative to the root of the repository)</li><li><strong>feedsToUse</strong>: In this case we have a nuget.config, so I select config</li><li><strong>nugetConfigPath</strong>: Path to the nuget.config, relative to the root of the repo</li></ul><p>The last two inputs are only used for restore (or when using dotnet build without restoring first).
Now all we have to do is to repeat these tasks for the proper commands we want to run.</p><p>Here&rsquo;s the final result</p><script src=https://gist.github.com/DanielSSilva/0c7905e516d91fda29053d6e3271584b.js></script><p>I&rsquo;ve used three &ldquo;things&rdquo; that you might not be familiar:</p><ul><li>$(buildConfiguration)</li><li>$(Build.ArtifactStagingDirectory)</li><li>task: PublishBuildArtifacts@1</li></ul><p>The first two are variables.
One will be defined by us (buildConfiguration), which will allow us to change between <em>Debug</em> and <em>Release</em> without the need to change the YAML and commit changes.
The second is a <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml" target=_blank rel=noopener>predefined variable</a>, which gives us the directory where our artifacts are published by default.
Speaking of which, the artifacts are published (meaning they become available outside of the agent) by running the task mentioned in the third point.</p><h1 id=creating-the-_actual_-pipeline>Creating the <em><strong>actual</strong></em> pipeline <a href=#creating-the-_actual_-pipeline class=anchor>üîó</a></h1><p>So far, what we&rsquo;ve done was to define what our pipeline will do.
But we need to create the pipeline that will run it.</p><ol><li>In Azure DevOps, navigate to the project and then go to Pipelines > Create Pipeline</li><li>Since I&rsquo;m using azure Repos on the same project, I&rsquo;ll select that option</li><li>Then select the respective repository</li><li>And on the &ldquo;Configure your pipeline&rdquo;, select &ldquo;Existing Azure Pipelines YAML file&rdquo;<p class=markdown-image><img src=/img/Azure-pipelines---YAML-structure-and-creating-simple-pipeline-for-Csharp-project/existingYaml.png alt></p></li><li>Select the branch and path to your YAML file.</li></ol><p>Now before saving and running it, remember that I mentioned that we will use the <em>buildConfiguration</em> variable?
Add it by clicking on <em>Variables</em> > New Variable.
It should look like this.</p><p><p class=markdown-image><img src=/img/Azure-pipelines---YAML-structure-and-creating-simple-pipeline-for-Csharp-project/buildConfiguration.png alt></p></p><p>We want our pipelines to run with Release by default, so that&rsquo;s the specified value.
Also make sure to tick the &ldquo;Let users override this value when running this pipeline&rdquo; so that you can generate builds with Debug.</p><p>You can now save and run the pipeline.</p><p>After running the pipeline, if everything went as expected, you should see something similar to this:<p class=markdown-image><img src=/img/Azure-pipelines---YAML-structure-and-creating-simple-pipeline-for-Csharp-project/pipelineExecution.png alt></p></p><p>Key points:</p><ul><li>1 - Here you can see all the jobs that ran and drill down into each job</li><li>2 - Useful information regarding when did the pipeline started and what was its&rsquo; duration</li><li>3 - The published artifact. In this case it will be the zip of the GreeterApp</li><li>4 - Test results and code coverage. I&rsquo;ll dedicate a post just for the code coverage part.</li></ul><h1 id=wrapping-up>Wrapping up <a href=#wrapping-up class=anchor>üîó</a></h1><p>In this post, I&rsquo;ve shared with you how to define a pipeline through YAML, as well as setting it up on Azure DevOps and running it.</p></div><div class=tags><a href=https://blog.danielssilva.dev/tags/azure-pipelines>Azure Pipelines</a>
<a href=https://blog.danielssilva.dev/tags/devops>DevOps</a></div><div id=comments><script>var id=11,commentsDiv;if(id){let t="https://github.com/DanielSSilva/blog/issues/".concat(id),n="https://api.github.com/repos/DanielSSilva/blog/issues/".concat(id,"/comments");commentsDiv=document.getElementById("comments");let e=new XMLHttpRequest;e.responseType="json",e.open("GET",n),e.setRequestHeader("Accept","application/vnd.github.v3.html+json"),e.send(),e.onload=function(){if(e.status!=200){let e=document.createElement("p");e.innerHTML="<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>",commentsDiv.appendChild(e)}else{let n=e.response,s=document.createElement("h2");s.innerHTML="Comments: ".concat(n.length),commentsDiv.appendChild(s);let o=document.createElement("p");o.innerHTML="<i>You can leave a comment using this <a href='".concat(t,"'>GitHub issue</a>.</i>"),commentsDiv.appendChild(o),n.forEach(function(e){let t=document.createElement("div");t.setAttribute("class","gh-comment"),t.innerHTML="".concat("<div class='gh-header'>","<img src='",e.user.avatar_url,"' />","<div style='margin:auto 0;'>","<b><a class='gh-username' href='",e.user.html_url,"'>",e.user.login,"</a></b>"," commented at <em>",new Date(e.created_at),"</em>","</div>","</div>","<div class='gh-body'>",e.body_html,"</div>"),commentsDiv.appendChild(t)})}},e.onerror=function(){let e=document.createElement("p");e.innerHTML="<i>Some error loading comments.</i>",commentsDiv.appendChild(e)}}</script></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/DanielSSilva rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/DanielSilv9 rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>¬© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Daniel Silva</div></footer></body></html>