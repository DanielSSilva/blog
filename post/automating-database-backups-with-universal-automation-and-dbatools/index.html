<!doctype html><html lang=en-us><head><title>Automating database backups with Universal Automation and dbatools | Daniel Silva's blog</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="I&rsquo;ve recently read about Universal Automation (UA), by Ironman Software. Among many other functionalities, it offers you the possibility to run background jobs and schedule your scripts to run at certain times. And that&rsquo;s exactly what we will be exploring today.
Before we start - Let&rsquo;s understand the product naming üîóThis might sound irrelevant for now, but you will understand in a minute why I&rsquo;m mentioning this.
The first time I heard about an Ironman Software product it was the Universal Dashboard (UD)."><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-136825774-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/tags>Tags</a>
<a href=https://www.danielssilva.dev>About</a></nav><main class=main><section id=single><h1 class=title>Automating database backups with Universal Automation and dbatools</h1><div class=tip><time datetime="2020-06-11 00:00:00 +0000 UTC">Jun 11, 2020</time>
<span class=split>¬∑</span>
<span>1289 words</span>
<span class=split>¬∑</span>
<span>7 minute read</span></div><div class=content><p>I&rsquo;ve recently read about <a href=https://ironmansoftware.com/universal-automation/ target=_blank rel=noopener>Universal Automation (UA)</a>, by <a href=https://ironmansoftware.com/ target=_blank rel=noopener>Ironman Software</a>.
Among many other functionalities, it offers you the possibility to run background jobs and schedule your scripts to run at certain times.
And that&rsquo;s exactly what we will be exploring today.</p><h1 id=before-we-start---lets-understand-the-product-naming>Before we start - Let&rsquo;s understand the product naming <a href=#before-we-start---lets-understand-the-product-naming class=anchor>üîó</a></h1><p>This might sound irrelevant for now, but you will understand in a minute why I&rsquo;m mentioning this.</p><p>The first time I heard about an Ironman Software product it was the <a href=https://docs.universaldashboard.io/ target=_blank rel=noopener>Universal Dashboard (UD)</a>.
In the meantime, another product surfaced: Universal Automation.</p><p>When searching for these products, you will find a note saying that these products (UA and UD) are part of something called <a href=https://ironmansoftware.com/powershell-universal/ target=_blank rel=noopener>PowerShell Universal</a>.</p><h2 id=so-what-is-universal>So what is Universal? <a href=#so-what-is-universal class=anchor>üîó</a></h2><p>Universal is, at the time of this writing, a combination of 3 products:</p><ul><li><a href=https://docs.ironmansoftware.com/api/about target=_blank rel=noopener>Universal API</a> - &ldquo;(&mldr;) provides the ability to define REST API endpoints using PowerShell&rdquo;</li><li><a href=https://ironmansoftware.com/universal-automation/ target=_blank rel=noopener>Universal Automation</a> - &ldquo;Universal Automation is the ultra-fast, simple, and lightweight automation platform for PowerShell.&rdquo;</li><li><a href=https://ironmansoftware.com/powershell-universal-dashboard/ target=_blank rel=noopener>Universal Dashboard</a> - &ldquo;Build web pages with PowerShell. No HTML or JavaScript required.&rdquo;</li></ul><p>This means that Universal is the way to go. From my understanding there won&rsquo;t be any maintenance (bug fixes, features, etc) on each individual product, only on the Universal itself.</p><h2 id=if-thats-the-way-to-go-why-are-you-showing-universal-automation>&ldquo;If that&rsquo;s the way to go, why are you showing Universal Automation?&rdquo; <a href=#if-thats-the-way-to-go-why-are-you-showing-universal-automation class=anchor>üîó</a></h2><p>At the time of this writing, the current Universal version is the 1.2.0 and I cannot get it to run on my Ubuntu 20.04.
The docs state that, for Linux, the validated distribution is Ubuntu 18.04, so hopefully in the next version I will be able to run it.</p><p>My first thought was that I could probably create a Ubuntu 18.04 container, install Universal and run it from a container. But&mldr; I&rsquo;m not familiar with that part of Docker.</p><p>Doing a quick search, I&rsquo;ve found that they provide a <a href=https://hub.docker.com/r/ironmansoftware/universalautomation/tags target=_blank rel=noopener>Docker image for Universal Automation</a>.
Well, it&rsquo;s not Universal, but since I&rsquo;m only interested in UA, I&rsquo;ll take that.
What you will see here, won&rsquo;t be much different from what you can see in Universal.</p><h1 id=installing-universal-automation>Installing Universal (Automation) <a href=#installing-universal-automation class=anchor>üîó</a></h1><p>We&rsquo;ve already seen that I will use the UA docker image in order to run it.
If you are able to use Universal, you can follow the <a href=https://docs.ironmansoftware.com/getting-started target=_blank rel=noopener>Getting Started docs</a>.</p><h2 id=running-ua-on-docker>Running UA on docker <a href=#running-ua-on-docker class=anchor>üîó</a></h2><p>In order to run UA, all we need to do is pull the image by doing <code>docker pull ironmansoftware/universalautomation:1.3.1</code>.</p><p>When it finishes, we can run it by doing <code>docker run --name UA -d -p 8080:8080 -p 10001:10001 ironmansoftware/universalautomation:1.3.1</code>.</p><p>In case you are not familiar with docker, this command will:</p><ul><li>Create a container with an <code>ironmansoftware/universalautomation:1.3.1</code> image;</li><li>Give the container the name specified after the <code>--name</code> switch (<code>UA</code> in this case)*;</li><li>Run the container in detached mode (<code>-d</code>). This allows us to keep using the terminal;</li><li>Map the ports (with the <code>-p</code> switch) 8080 on the container to the port 8080 on the host (our machine). Same for the port 10001;</li></ul><p>*<strong>HINT</strong>: I always like to give the containers a name, so that it can be easier to stop, remove, etc</p><p>We can then confirm that UA is running by launching <code>http://localhost:8080/</code> on our browser.</p><p>I recommend that you check <a href="https://www.youtube.com/watch?v=u9Hq4X8V7VY" target=_blank rel=noopener>Introducing Universal Automation</a> so that you get familiar with the environment and understand the capabilities.</p><h1 id=some-concepts>Some concepts <a href=#some-concepts class=anchor>üîó</a></h1><p>Let me quickly introduce you some concepts that will be used here:</p><ul><li>Script - That&rsquo;s the same as your PowerShell scripts. It&rsquo;s a piece of code that can be executed.</li><li>Job - Has the responsibility to execute the script and report the execution result such has errors, progress, and so on.</li><li>Schedule - Will run a job at a specified time</li></ul><h1 id=creating-a-script>Creating a script <a href=#creating-a-script class=anchor>üîó</a></h1><p>Once we open the UA, we can create a new script</p><p><p class=markdown-image><img src=/img/Automating_database_backups_with_Universal_Automation_and_dbatools/New_Script.png alt="new script"></p></p><p>We are asked for some information about the script.
After filling that, we jump to the script and start editing it.</p><h2 id=first-attempt>First attempt <a href=#first-attempt class=anchor>üîó</a></h2><p>Here&rsquo;s my first attempt to backup a database:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#080;font-style:italic># BackupDatabase</span>
</span></span><span style=display:flex><span><span style=color:#b8860b>$secpasswd</span> = <span style=color:#a2f>ConvertTo-SecureString</span> <span style=color:#b44>&#34;Str0ngPassw0rd&#34;</span> -AsPlainText -Force 
</span></span><span style=display:flex><span><span style=color:#b8860b>$credentials</span> = <span style=color:#a2f>New-Object</span> System.Management.Automation.PSCredential (<span style=color:#b44>&#34;sa&#34;</span>, <span style=color:#b8860b>$secpasswd</span>) 
</span></span><span style=display:flex><span><span style=color:#b8860b>$backupName</span> = <span style=color:#b44>&#34;</span>$(<span style=color:#a2f>Get-Date</span> -Format yyyy_MM_dd_HH_mm)<span style=color:#b44>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f>Backup-DbaDatabase</span> -IgnoreFileChecks -SqlInstance <span style=color:#b44>&#34;192.168.1.80&#34;</span> -SqlCredential <span style=color:#b8860b>$credentials</span>  -database <span style=color:#b44>&#34;demo&#34;</span> -BackupDirectory <span style=color:#b44>&#34;/backup&#34;</span> -BackupFile <span style=color:#b44>&#34;$backupName.bak&#34;</span>
</span></span></code></pre></div><p>After saving and running it, there&rsquo;s an error:</p><p><p class=markdown-image><img src=/img/Automating_database_backups_with_Universal_Automation_and_dbatools/BackupError.png alt="Backup error"></p></p><p>Well, of course it is not recognized. This is a <a href=https://dbatools.io/ target=_blank rel=noopener>dbatools</a> command, and since we are running on a container that does not have dbatools installed by default, we have to install it.</p><h2 id=installing-dbatools-on-the-container>Installing dbatools on the container <a href=#installing-dbatools-on-the-container class=anchor>üîó</a></h2><p>To do that, we need to access the container. This can be done by executing <code>docker exec -it UA /bin/bash</code>.</p><p>( See why it is good to give a name to your container? :) )</p><p>Then, launch PowerShell via terminal (<code>pwsh</code>) and do <code>Install-Module dbatools</code>.</p><p>Running the same script again on UA, it now runs successfully!</p><p><p class=markdown-image><img src=/img/Automating_database_backups_with_Universal_Automation_and_dbatools/Successful_backup.png alt="Successful Backup"></p></p><p><strong>Bonus tip</strong> : you can run this &ldquo;all-in-one&rdquo; command which will launch Powershell and install dbatools <code>docker exec -it UA /usr/bin/pwsh -interactive -command Install-Module dbatools</code></p><h1 id=scheduling-the-backup-script>Scheduling the backup script <a href=#scheduling-the-backup-script class=anchor>üîó</a></h1><p>Let&rsquo;s consider that this script has to execute every day, twice a day: at 10 am and at 6 pm.</p><p>Going back to our script, we can find a schedule option inside the 3 dots on the top right.</p><p><p class=markdown-image><img src=/img/Automating_database_backups_with_Universal_Automation_and_dbatools/Schedule.png alt=Schedule></p></p><p>There are many options baked in it already, such as running every minute, every hour, etc.
In this case, none of those options match our criteria.
But there&rsquo;s another tab called CRON.
That&rsquo;s the one that will be used.
For that, let&rsquo;s create two schedule entries, like this:</p><p><p class=markdown-image><img src=/img/Automating_database_backups_with_Universal_Automation_and_dbatools/schedule_cron.png alt="schedule cron"></p></p><p>After creating as many schedules as we want, we can see all our schedules by going to the schedules tab.</p><p><p class=markdown-image><img src=/img/Automating_database_backups_with_Universal_Automation_and_dbatools/schedule_list.png alt="schedule list"></p></p><p>With this, we have our backup script running everyday at 10 am and 6 pm, without us having to remember that we need to execute the script.</p><h1 id=viewing-jobs-executions-and-results>Viewing jobs executions and results <a href=#viewing-jobs-executions-and-results class=anchor>üîó</a></h1><p>You can easily check the jobs that ran (either by schedule or manually), what&rsquo;s the result, errors, etc.</p><p>Here&rsquo;s an example of a script that I&rsquo;ve scheduled to run every minute:</p><p><p class=markdown-image><img src=/img/Automating_database_backups_with_Universal_Automation_and_dbatools/schedule_sample.png alt="schedule results"></p></p><p>And the results can be seen by clicking on the <code>view</code> button.
The result looks like this:</p><p><p class=markdown-image><img src=/img/Automating_database_backups_with_Universal_Automation_and_dbatools/Job_result.png alt="job result"></p></p><h1 id=bonus---leveraging-the-secrets>Bonus - Leveraging the Secrets <a href=#bonus---leveraging-the-secrets class=anchor>üîó</a></h1><p>If you navigate to the <code>variables</code> tab, you can see that you can add variables.
This is cool if you have multiple scripts that have the same configuration (paths, names, etc).</p><p>But what&rsquo;s also cool is that UA allows you to use secrets, meaning you can store your database credentials and avoid placing them as plain text on your scripts.
Unfortunately, I wasn&rsquo;t able to make it work on the version that I&rsquo;m using.
I see no errors, it says the secret is created successfully, but I can&rsquo;t see it or use it.</p><p><del>I expect that this is something going wrong on my side and that it&rsquo;s working as expected in Universal.</del></p><p>I&rsquo;ll update this post if I can get it working.</p><p>UPDATE: So after talking with Adam Driscoll (<a href=https://twitter.com/adamdriscoll target=_blank rel=noopener>t</a>), turns out that Universal Automation relies on <code>Microsoft.PowerShell.SecretManagement</code> module, which currently only works on Windows.
This means that, when there&rsquo;s a working version of this module on other platforms, Universal will allow you to store your secrets as well!
The good news is that if you use Windows, you can already leverage from it.</p><h1 id=wrapping-up>Wrapping up <a href=#wrapping-up class=anchor>üîó</a></h1><p>With this post we&rsquo;ve seen what&rsquo;s Universal Automation, Universal and the different naming/functionalities.</p><p>We&rsquo;ve then used UA through a Docker container, created a script to backup our database and scheduled it to run twice a day, every day.</p><p>Hopefully this was a good introduction for you to understand the power of Universal and how you can leverage from it to make your work easier.</p><p>On a side note, something that I&rsquo;ve found really amazing is that UA was running in a container, and my database is on another container, and it simply worked out of the box!</p><p>Thanks for reading!</p></div><div class=tags><a href=https://blog.danielssilva.dev/tags/powershell>PowerShell</a>
<a href=https://blog.danielssilva.dev/tags/sql>SQL</a></div><div id=comment><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//DanielSSilva.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/DanielSSilva rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/DanielSilv9 rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>¬© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Daniel Silva</div></footer></body></html>