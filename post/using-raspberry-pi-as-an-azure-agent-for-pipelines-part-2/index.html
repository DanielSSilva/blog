<!doctype html><html lang=en-us><head><meta name=twitter:card content="summary"><meta name=twitter:title content="Using RaspberryPi as an Azure agent for Pipelines (Part 2) &#183; Daniel Silva's blog"><meta name=twitter:description content="In the first part of this series, we have seen how we can setup a self hosted agent (in this case on a Raspberry Pi). To recap, here&amp;amp;rsquo;s a quick list of things required to do on the target host (this is agnostic to the underlying operating system):
Get the latest agent version available (head to the Azure DevOps website &amp;amp;gt; Project settings &amp;amp;gt; Agent Pools &amp;amp;gt; your pool &amp;amp;gt; new agent &amp;amp;gt; download agent) Extract the file Run the config file and specify: Server URL Your PAT Agent pool Agent name Work folder Run the run file or configure as a service."><meta name=twitter:site content="DanielSilv9"><meta name=twitter:creator content="DanielSilv9"><meta name=twitter:image content="/img/coast.jpeg"><meta property="og:locale" content="en_GB"><meta property="og:type" content="article"><meta property="og:title" content="Using RaspberryPi as an Azure agent for Pipelines (Part 2) &#183; Daniel Silva's blog"><meta property="og:description" content="In the first part of this series, we have seen how we can setup a self hosted agent (in this case on a Raspberry Pi). To recap, here&amp;amp;rsquo;s a quick list of things required to do on the target host (this is agnostic to the underlying operating system):
Get the latest agent version available (head to the Azure DevOps website &amp;amp;gt; Project settings &amp;amp;gt; Agent Pools &amp;amp;gt; your pool &amp;amp;gt; new agent &amp;amp;gt; download agent) Extract the file Run the config file and specify: Server URL Your PAT Agent pool Agent name Work folder Run the run file or configure as a service."><meta property="og:url" content="https://blog.danielssilva.dev/post/using-raspberry-pi-as-an-azure-agent-for-pipelines-part-2/"><meta property="og:site_name" content="Daniel Silva's blog"><meta property="article:published_time" content="2020-11-13T00:00:00Z"><title>Using RaspberryPi as an Azure agent for Pipelines (Part 2) | Daniel Silva's blog</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="In the first part of this series, we have seen how we can setup a self hosted agent (in this case on a Raspberry Pi). To recap, here&rsquo;s a quick list of things required to do on the target host (this is agnostic to the underlying operating system):
Get the latest agent version available (head to the Azure DevOps website > Project settings > Agent Pools > your pool > new agent > download agent) Extract the file Run the config file and specify: Server URL Your PAT Agent pool Agent name Work folder Run the run file or configure as a service."><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-136825774-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/tags>Tags</a>
<a href=https://www.danielssilva.dev>About</a></nav><main class=main><section id=single><h1 class=title>Using RaspberryPi as an Azure agent for Pipelines (Part 2)</h1><div class=tip><time datetime="2020-11-13 00:00:00 +0000 UTC">Nov 13, 2020</time>
<span class=split>¬∑</span>
<span>1103 words</span>
<span class=split>¬∑</span>
<span>6 minute read</span></div><div class=content><p>In the <a href=https://danielssilva.dev/2020-09-28-Using-Raspberry-Pi-as-an-Azure-Agent-for-Pipelines/ target=_blank rel=noopener>first part</a> of this series, we have seen how we can setup a self hosted agent (in this case on a Raspberry Pi).
To recap, here&rsquo;s a quick list of things required to do on the target host (this is agnostic to the underlying operating system):</p><ul><li>Get the latest agent version available (head to the Azure DevOps website > Project settings > Agent Pools > your pool > new agent > download agent)</li><li>Extract the file</li><li>Run the config file and specify:<ul><li>Server URL</li><li>Your PAT</li><li>Agent pool</li><li>Agent name</li><li>Work folder</li></ul></li><li>Run the run file or configure as a service.</li></ul><p>This is fine and easy enough, if you are targeting just one host.</p><h1 id=deploying-agents-to-my-raspberry-pi-cluster>Deploying agents to my Raspberry Pi cluster <a href=#deploying-agents-to-my-raspberry-pi-cluster class=anchor>üîó</a></h1><p>I have a cluster consisting of 4x RaspberryPi4 2GB.
Repeating the previous task 3 more times, would not only consume some time, but would also be error-prone.</p><p>While I was studying this topic, I found that you can also deploy agents to containers (we will cover that in a 3rd part).
You can deploy it to containers by essentially <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops#create-and-build-the-dockerfile-1" target=_blank rel=noopener>running a script that Microsoft made</a> that will do all of the previous steps for you, and run the config with an &ldquo;unattended&rdquo; switch.</p><p>That seems to be a promising way to overcome the burden of having to configure all of those steps again and again.
However, there were some changes that I&rsquo;ve had to make to that script so that it worked in our case, as we will see next.
Even so, we still have to figure a way to run this script on each host.</p><h2 id=ansible-to-the-rescue>Ansible to the rescue <a href=#ansible-to-the-rescue class=anchor>üîó</a></h2><p>My latest post was about <a href=https://danielssilva.dev/2020-11-04-A-very-small-introduction-to-Ansible/ target=_blank rel=noopener>&ldquo;A (very) small introduction to Ansible&rdquo;</a> and it was specifically written with this scenario in mind.
If you are not familiar with Ansible, I strongly suggest that you give that post a read, so that the next part doesn&rsquo;t seem (so) magic.</p><p>In short: we will use Ansible playbooks to automate the whole previous process.</p><h3 id=the-playbook>The playbook <a href=#the-playbook class=anchor>üîó</a></h3><p>You can find the playbook <a href=https://github.com/DanielSSilva/AzPipelines_selfHosted/tree/main/2_multipleSelfHostedAgent target=_blank rel=noopener>here</a>, along with the rest of the files needed to successfully deploy an agent.</p><p>This playbook will:</p><ol><li>Install jq, if it&rsquo;s not already present (required to query which agent to download)</li><li>Create the folder that will hold the scripts</li><li>Create the folder that will have the required components to run the agent</li><li>Create the folder that will hold the token</li><li>Copy the scripts:</li></ol><ul><li>constants - Holds information that our agent needs. (You will need to change this file to match your reality)</li><li>downloadAndInstallAgent - Downloads and installs the agent</li><li>setup_dotnet - Downloads and installs dotnet 3.1</li></ul><ol><li>Download and install the agent, by running the <code>downloadAndInstallAgent.sh</code>script</li><li>Download and install dotnet 3.1 by running the <code>setup_dotnet.sh</code>script</li><li>Add dotnet to the <code>PATH</code> and <code>DOTNET_ROOT</code></li><li>Force the agent to reload the environment variables</li><li>Install the agent as a service</li><li>Start the service</li></ol><p>To execute the playbook we just need to run the following command: <code>ansible-playbook playbook.yml -K</code>. We will see this <code>-K</code> later on.</p><p>Here is a screenshot of the playbook result:</p><p><p class=markdown-image><img src=/img/Using-Raspberry-Pi-as-an-Azure-Agent-for-Pipelines-Part2/playbook_result.png alt="playbook result"></p></p><p>If we head to our pool on Azure DevOps, we can see that all nodes are up and running.</p><p><p class=markdown-image><img src=/img/Using-Raspberry-Pi-as-an-Azure-Agent-for-Pipelines-Part2/agents_pool.png alt="agents pool"></p></p><h1 id=running-multiple-pipelines-at-the-same-time>Running multiple pipelines at the same time <a href=#running-multiple-pipelines-at-the-same-time class=anchor>üîó</a></h1><p>If you are reading this article, chances are that you want to either have your own agent to speed up testing, or you probably want to speed up the pipelines process by running multiple pipelines at the same time.</p><p>Keep in mind that running parallel jobs might have some additional costs.
Take a look at this image (this can be found on project settings > Pipelines > Parallel jobs):</p><p><p class=markdown-image><img src=/img/Using-Raspberry-Pi-as-an-Azure-Agent-for-Pipelines-Part2/parallel_jobs.png alt="parallel jobs"></p></p><p>In this case, because I&rsquo;ve created this project as public, I have unlimited parallel jobs!</p><p>Let&rsquo;s run some pipelines and see if they are actually running in parallel (you can clone/fork <a href=https://github.com/DanielSSilva/CI-CD-Rpi target=_blank rel=noopener>this repository</a>, which is the same that I&rsquo;ve used on part 1). It has the 4 pipelines that are running here:</p><p><p class=markdown-image><img src=/img/Using-Raspberry-Pi-as-an-Azure-Agent-for-Pipelines-Part2/agents_running.png alt="agents running"></p></p><p>As you can see, all the pipelines waited for less than 1 second before being assigned to an agent and started running.</p><h1 id=playbooks---behind-the-scenes---some-caveats>Playbooks - Behind the scenes - some caveats <a href=#playbooks---behind-the-scenes---some-caveats class=anchor>üîó</a></h1><p>Using this playbook really speeds up the deployment/configuration process.
But during the creation of this, I&rsquo;ve &ldquo;hit the wall&rdquo; many times, sometimes because I&rsquo;m new to Ansible, others because it has some odd behaviour.</p><p>Let me highlight some of the points that I consider to be key:
On the playbook:</p><ul><li>the <code>-K</code> switch: As mentioned before, this is required so that Ansible knows what&rsquo;s the <code>sudo</code> password so that it can use it on modules that run with <code>become:true</code></li><li><code>become</code>: When a module requires higher privileges (sudo), we can specify <code>become: true</code>. By doing this, we are telling Ansible to run that module as sudo.</li><li>vars: Variables are really useful. In this case, built-in variables such as <code>{{ansible_env.HOME}}</code> and <code>{{ansible_env.PATH}}</code> allowed me to specify the home directory and the path, without having to hardcode them into the playbook. Notice that the HOME variable is related to the <code>remote_user</code> (daniel in this case)</li><li>copying scripts: This one was interesting, at least for me as someone who&rsquo;s not totally familiar with unix systems. When I first used the copy module, I didn&rsquo;t specify the mode. The scripts were executable on my machine (I ran <code>chmod +x scriptname.sh</code>) but they were not executable when Ansible tried to run them. I had to use the <code>mode</code> to specify that it has the execute attribute (the 7 on 0744).</li><li>command module: Multiple things happened with this module.<ul><li><code>argv</code>: The parameters of the command. If you notice, the first parameter is actually the command that we want to run. The rest of the parameters are parameters that will be passed to the script being called.</li><li><code>args: chdir</code>: the <code>svc.sh</code> script requires that the command is executed from the same directory of that file. <code>chdir</code> specified the path on which the command will be when it&rsquo;s executed.</li></ul></li></ul><p>Regarding the <code>downloadAndInstallAgent.sh</code> script:</p><ul><li>I&rsquo;ve tried to simplify the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops#create-and-build-the-dockerfile-1" target=_blank rel=noopener>original script</a>, by using constants instead of environment variables. I&rsquo;ve also changed the hardcoded URL to download the installer from <code>platform=linux-x64</code> to <code>platform=linux-arm64</code></li></ul><h1 id=wrapping-up>Wrapping up <a href=#wrapping-up class=anchor>üîó</a></h1><p>Hopefully this blog post gave you a better understanding on how you can deploy and launch an agent more quickly, and also deploy agents to multiple hosts.
In this case I&rsquo;ve used 4 Raspberry Pi, but this is expected to work across any other host that supports agents (with some minor tweaks on some cases).</p><p>If you have any suggestions or questions, let me know by reaching out on <a href=https://twitter.com/DanielSilv9 target=_blank rel=noopener>twitter</a>, <a href=https://www.linkedin.com/in/danielssilva target=_blank rel=noopener>linkedIn</a> or create a GitHub issue on my <a href=https://github.com/DanielSSilva/Presentations/issues target=_blank rel=noopener>Presentations repository</a>.</p><p>Thank you for reading!</p></div><div class=tags><a href=https://blog.danielssilva.dev/tags/raspberrypi>RaspberryPi</a>
<a href=https://blog.danielssilva.dev/tags/devops>DevOps</a>
<a href=https://blog.danielssilva.dev/tags/azure>Azure</a></div><div id=comments><script>var id=9,commentsDiv;if(id){let t="https://github.com/DanielSSilva/blog/issues/".concat(id),n="https://api.github.com/repos/DanielSSilva/blog/issues/".concat(id,"/comments");commentsDiv=document.getElementById("comments");let e=new XMLHttpRequest;e.responseType="json",e.open("GET",n),e.setRequestHeader("Accept","application/vnd.github.v3.html+json"),e.send(),e.onload=function(){if(e.status!=200){let e=document.createElement("p");e.innerHTML="<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>",commentsDiv.appendChild(e)}else{let n=e.response,s=document.createElement("h2");s.innerHTML="Comments: ".concat(n.length),commentsDiv.appendChild(s);let o=document.createElement("p");o.innerHTML="<i>You can leave a comment using this <a href='".concat(t,"'>GitHub issue</a>.</i>"),commentsDiv.appendChild(o),n.forEach(function(e){let t=document.createElement("div");t.setAttribute("class","gh-comment"),t.innerHTML="".concat("<div class='gh-header'>","<img src='",e.user.avatar_url,"' />","<div style='margin:auto 0;'>","<b><a class='gh-username' href='",e.user.html_url,"'>",e.user.login,"</a></b>"," commented at <em>",new Date(e.created_at),"</em>","</div>","</div>","<div class='gh-body'>",e.body_html,"</div>"),commentsDiv.appendChild(t)})}},e.onerror=function(){let e=document.createElement("p");e.innerHTML="<i>Some error loading comments.</i>",commentsDiv.appendChild(e)}}</script></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/DanielSSilva rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/DanielSilv9 rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>¬© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Daniel Silva</div></footer></body></html>