<!doctype html><html lang=en-us><head><meta name=twitter:image content="https://blog.danielssilva.dev/img/coast.jpeg"><meta name=twitter:card content="summary_large_image"><meta property="og:locale" content="en_US"><meta property="og:type" content="website"><meta name=twitter:creator content="@DanielSilv9"><meta name=twitter:title content="Daniel Silva's blog"><meta property="twitter:site" content="@DanielSilv9"><meta property="og:url" content="https://blog.danielssilva.dev/post/dbatools-is-not-just-for-dbas---import-dbacsv/"><meta name=twitter:title content="dbatools is not just for DBAs - Import-DbaCsv &#183; Daniel Silva's blog"><meta property="og:image" content="https://blog.danielssilva.dev/img/coast.jpeg"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The first time I&rsquo;ve heard about dbatools was on its early stages and, although it seemed really interesting, I didn&rsquo;t know anything about PowerShell, nor I had to work with SQL professionally. Moreover, to me it looked like it was &ldquo;focused&rdquo; on helping DBAs (maybe hence its name?). Even though I&rsquo;ve never contributed to the project, I&rsquo;ve always kept an eye on it.
Why do I need it now? Some context üîóI usually have to analyse logs in order to perform some C#/SQL troubleshooting/debugging/performance tuning."><meta name=generator content="Hugo 0.101.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-136825774-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/tags>Tags</a>
<a href=https://www.danielssilva.dev>About</a></nav><main class=main><section id=single><h1 class=title>dbatools is not just for DBAs - Import-DbaCsv</h1><div class=tip><time datetime="2020-04-22 00:00:00 +0000 UTC">Apr 22, 2020</time>
<span class=split>¬∑</span>
<span>2487 words</span>
<span class=split>¬∑</span>
<span>12 minute read</span></div><div class=content><p>The first time I&rsquo;ve heard about <a href=https://dbatools.io/ target=_blank rel=noopener>dbatools</a> was on its early stages and, although it seemed really interesting, I didn&rsquo;t know anything about PowerShell, nor I had to work with SQL professionally.
Moreover, to me it looked like it was &ldquo;focused&rdquo; on helping DBAs (maybe hence its name?).
Even though I&rsquo;ve never contributed to the project, I&rsquo;ve always kept an eye on it.</p><h1 id=why-do-i-need-it-now-some-context>Why do I need it now? Some context <a href=#why-do-i-need-it-now-some-context class=anchor>üîó</a></h1><p>I usually have to analyse logs in order to perform some C#/SQL troubleshooting/debugging/performance tuning.
The approach that I usually take is to use Excel and import the log file as a table, so that I can filter, highlight and so on.</p><p>For most of the times, this is enough and I can get my job done.
But there were times that I&rsquo;ve struggled when trying to filter for more than one condition on same column, some issues with sorting, wrong data types, etc.</p><h2 id=but-theres-more>But there&rsquo;s more <a href=#but-theres-more class=anchor>üîó</a></h2><p>I&rsquo;ve decided that I want to learn more about Linux and because (for me) the best way to learn something is by use and investigating, I&rsquo;ve installed Ubuntu to be my daily driver.</p><p>Fortunately, one can now easily use SQL Server on Linux, as well as .NET and PowerShell.
I&rsquo;ve been using a docker container with SQL Server, and for that reason the installation and database restore were really easy and fast to get working (hint: I will probably write a <em>dbatools isn&rsquo;t just for DBAs part 2 - Backup and Restore</em>).</p><p>After setting everything, I had to analyse a log and, to my surprise, I couldn&rsquo;t find that Excel feature that I was used to in LibreOffice . I&rsquo;ve decided to try OpenOffice, but the result was the same.</p><h1 id=ok-so-what-now---the-solution>Ok so what now? - The solution <a href=#ok-so-what-now---the-solution class=anchor>üîó</a></h1><p>I&rsquo;ve once explored a way to store logs on a database.
And after some digging and talking to Cl√°udio Silva (<a href=https://claudioessilva.eu/ target=_blank rel=noopener>b</a>|<a href=https://twitter.com/claudioessilva target=_blank rel=noopener>t</a>), he suggested that I took a look at a dbatools&rsquo; cmdlet: <code>Import-DbaCsv</code>.</p><p>Because I&rsquo;m more comfortable with SQL than with Excel, this seems a good case to use what I&rsquo;ve learned at that time.</p><p>I can even has some advantages, such as:</p><ul><li>You can easily do a multi condition filtering: i.e. All logging info that contains the string &ldquo;Entered on controller&rdquo; <em>OR</em> &ldquo;Left the controller&rdquo;. In excel, I only know how to filter by one condition (I&rsquo;m sure there might be some way to achieve this);</li><li>It&rsquo;s easier to keep track of filters: Because in SQL it will all be in a WHERE clause, one can easily look at that and understand what&rsquo;s being filtered. In Excel you have to look at the headers, find the filter symbol, <em>and</em> click on it to see the filter condition.</li><li>If you have the info, you can join with other tables to gather even more information: Ok, this only works if you are analysing logs from development (I&rsquo;m assuming you don&rsquo;t have the production data on your development environment). Let&rsquo;s say that you are storing the id of the user that made the request. You can do an Inner Join with the user table, and get more information about that user.</li><li>It&rsquo;s easier to show/hide columns: In Excel it feels I&rsquo;m playing a puzzle game whenever I want to hide/show columns or sort it in different order. In SQL all I have to do is change the SELECT statement.</li><li>Faster loading data - When I want to analyse a new log file, all I have to do is call a PowerShell function (we&rsquo;ll see it later) that gets the path as parameter, imports everything to the database and it&rsquo;s good to go. In Excel I have to go to the data tab, choose import and select the file. As bonus, excel always converts my <code>Date</code> column and removes the seconds and milliseconds, which are relevant when analysing performance.</li></ul><p>For all of these, I&rsquo;ve decided to drop Excel/LibreOffice and go with SQL.</p><h2 id=implementation>Implementation <a href=#implementation class=anchor>üîó</a></h2><p>I suggest you take a look at <code>Import-Csv</code> <a href=https://docs.dbatools.io/#Import-DbaCsv target=_blank rel=noopener>documentation</a>, as it contains many parameters that can make sense for your case.
Let me show you the final execution, and we will break it down to understand what it&rsquo;s doing:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a2f>Import-DbaCsv</span> -Path <span style=color:#b44>&#39;/media/daniel/Data/logs/logExample.log&#39;</span> -Delimiter <span style=color:#b44>&#39;|&#39;</span> -SqlInstance <span style=color:#b44>&#34;Localhost&#34;</span> -SqlCredential <span style=color:#b8860b>$credentials</span> -Database <span style=color:#b44>&#39;LogHolder&#39;</span> -AutoCreateTable
</span></span></code></pre></div><ul><li><code>Path</code>: As the name implies, this is the path for the log file. Notice that it accepts an <code>Object[]</code>, meaning you can pass multiple files to be processed;</li><li><code>Delimiter</code>: As you might or might not know, although it&rsquo;s called csv (<strong>C</strong>omma <strong>S</strong>eparated <strong>V</strong>alue), the delimiter can be other character. For example in my case it is the pipe -> <code>|</code>;</li><li><code>SqlInstance</code>: The instance you will target to write the content;</li><li><code>SqlCredential</code>: A <code>PSCredential</code> object which holds the credentials to get access to the instance;</li><li><code>Database</code>: The target database on which the content will be written.</li><li><code>AutoCreateTable</code>: Here&rsquo;s something really cool about this one - Let&rsquo;s say that you don&rsquo;t care about the attributes type (whether it&rsquo;s a <code>nvarchar</code>, a <code>datatimeoffset</code>, etc), or you don&rsquo;t want to create the table manually because your csv contains 30 columns and you just want a quick way to dump and analyse the information. You can use the <code>-AutoCreateTable</code> switch, which, as the name implies, will create the table for you, with the columns you have on your csv. If you don&rsquo;t specify a <code>Table</code> name, it will create the table with the name of your csv file</li><li><code>Table</code>: The target table to which the content will be written. Although it&rsquo;s not present here, it will be used later.</li></ul><h2 id=lets-look-at-some-examples>Let&rsquo;s look at some examples <a href=#lets-look-at-some-examples class=anchor>üîó</a></h2><p>For this case, we will use a log that I&rsquo;ve generated. It has some columns that are usually useful for a dotnet api log. Note that this is some random non-sense generated data.</p><script src=https://gist.github.com/DanielSSilva/3d6e8b1b64722130dc9aa61f28084977.js></script><p>For this first iteration, we will use the <code>-AutoCreateTable</code> and see how it behaves.
Let&rsquo;s run the command I&rsquo;ve shown above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b8860b>$paramSplat</span> = @{
</span></span><span style=display:flex><span>	Path = <span style=color:#b44>&#39;/media/daniel/Data/logs/logExample.log&#39;</span>
</span></span><span style=display:flex><span>	Delimiter = <span style=color:#b44>&#39;|&#39;</span>
</span></span><span style=display:flex><span>	SqlInstance = <span style=color:#b44>&#39;Localhost&#39;</span>
</span></span><span style=display:flex><span>	SqlCredential = <span style=color:#b8860b>$credentials</span>
</span></span><span style=display:flex><span>	Database = <span style=color:#b44>&#39;LogHolder&#39;</span>
</span></span><span style=display:flex><span>	AutoCreateTable = <span style=color:#b8860b>$true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a2f>Import-DbaCsv</span> <span style=color:#b8860b>@paramSplat</span>
</span></span></code></pre></div><p>Well, that&rsquo;s the same command but formatted differently.
I&rsquo;ve used <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_splatting?view=powershell-7" target=_blank rel=noopener>splatting</a> because I consider that it makes the core more readable and easier to change any parameter, if we have to.</p><p>Here&rsquo;s the result of that execution:</p><p><p class=markdown-image><img src=/img/dbatools-isn-t-just-for-DBAs/import-dbacsv_1stIteration.png alt=import-dbacsv_1stIteration></p></p><p>Interesting/Relevant points:</p><ul><li>Notice the <code>Table</code> name on the output. As I&rsquo;ve said, the table name has the same name as the log file because we haven&rsquo;t specified a table name.</li><li>It gives us the information of how many rows were copied, plus at which &ldquo;rate&rdquo; it wrote (notice the 51 RowsPerSecond)</li></ul><p>Let&rsquo;s take a look at our table, shall we?</p><p><p class=markdown-image><img src=/img/dbatools-isn-t-just-for-DBAs/1st-iteration-database.png alt=1st-iteration-database></p></p><p>Well, that&rsquo;s pretty much what was expected at this point. And that&rsquo;s good!
From now on, we are querying SQL which, for my case and with my experience, is much more powerful in this scenario.</p><h3 id=what-about-bigger-files>What about bigger files? <a href=#what-about-bigger-files class=anchor>üîó</a></h3><p>Before we proceed, I think it makes sense to list the specs of my machine, so that we can take better conclusions when considering times.</p><p>It is an 8th gen i5 (i5-8265U Quad-Core, 1.60 GHz with Turbo up to 3.90 GHz, if it matters), 16GB of RAM.</p><p>Let&rsquo;s try to create a bigger file and then import it on our existing table.
And let&rsquo;s use PowerShell to do just that:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b8860b>$originalFilePath</span> = <span style=color:#b44>&#39;/media/daniel/Data/logs/logExample.log&#39;</span> 
</span></span><span style=display:flex><span><span style=color:#b8860b>$copyFilePath</span> = <span style=color:#b44>&#39;/media/daniel/Data/logs/logExampleMultiplied.log&#39;</span> 
</span></span><span style=display:flex><span><span style=color:#a2f>Copy-Item</span> -Path <span style=color:#b8860b>$originalFilePath</span> -Destination <span style=color:#b8860b>$copyFilePath</span>
</span></span><span style=display:flex><span><span style=color:#a2f>Out-File</span> <span style=color:#b8860b>$copyFilePath</span> -Append -InputObject <span style=color:#b44>&#34; &#34;</span> <span style=color:#080;font-style:italic>#force a new line, so that when we append the info, it will be appended to the beginning of a new line</span>
</span></span><span style=display:flex><span>1..5000 | <span style=color:#a2f>foreach-object</span> { <span style=color:#a2f>Get-Content</span> <span style=color:#b8860b>$originalFilePath</span> | <span style=color:#a2f>Select-Object</span> -Skip 1 } | <span style=color:#a2f>Out-File</span> <span style=color:#b8860b>$copyFilePath</span> -Append 
</span></span><span style=display:flex><span><span style=color:#080;font-style:italic>#Select-Object -Skip 1 allows us to copy everything other than the header</span>
</span></span></code></pre></div><p>So, our original sample has 8 lines, now we&rsquo;ve multiplied that by 5000, which means we will add 40000. In total, we will add 40008 new records. Let&rsquo;s see how it behaves now.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b8860b>$paramSplat</span> = @{
</span></span><span style=display:flex><span>	Path = <span style=color:#b44>&#39;/media/daniel/Data/logs/logExampleMultiplied.log&#39;</span>
</span></span><span style=display:flex><span>	Delimiter = <span style=color:#b44>&#39;|&#39;</span>
</span></span><span style=display:flex><span>	SqlInstance = <span style=color:#b44>&#39;Localhost&#39;</span>
</span></span><span style=display:flex><span>	SqlCredential = <span style=color:#b8860b>$credentials</span>
</span></span><span style=display:flex><span>	Database = <span style=color:#b44>&#39;LogHolder&#39;</span>
</span></span><span style=display:flex><span>	Table = <span style=color:#b44>&#39;logExample&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a2f>Import-DbaCsv</span> <span style=color:#b8860b>@paramSplat</span>
</span></span></code></pre></div><p>Notice that I&rsquo;ve now removed the <code>AutoCreateTable</code> switch and specified the table name instead. This is because I want to append the new results to our existing table.</p><p><p class=markdown-image><img src=/img/dbatools-isn-t-just-for-DBAs/manyRowsImport.png alt=manyRowsImport></p></p><p>Our multiplication generated a file with 8.7MB. Well that&rsquo;s not that big&mldr; But it was processed at a rate of 47060 rows per second, still taking less than 1 second ü§Ø.</p><p>Ok I should not be surprised by that.
Compared to what SQL can handle, 40k rows is nothing&mldr;</p><p>For that reason, I&rsquo;ve grabbed the created file and multiplied that for 500. So now we have 500x40.008 rows, which makes a total of 2.000.400 rows.</p><p>Now that gotta be something! PowerShell even took some time to create that file.</p><p>How long do you think that it will take (on my machine) to import 2 million records?</p><p><p class=markdown-image><img src=/img/dbatools-isn-t-just-for-DBAs/multipliedMultiplied.png alt=multipliedMultiplied></p></p><p>39.39 seconds to copy 2.000.400 rows, at a rate of 50785 rows per second. Still pretty amazing if you ask me!</p><p>There&rsquo;s also a <code>-BatchSize</code> parameter that you can explore and try to improve the time even more.</p><h3 id=querying-our-logs>Querying our Logs <a href=#querying-our-logs class=anchor>üîó</a></h3><p>From here, is really up to you to apply whatever filters, joins, etc that you want.</p><p>For instance, say that we want to get all results between a certain time, and only care about the date and info column.
In Excel any of the other mentioned programs, we need to select the columns and then select &ldquo;hide&rdquo;.
After, we need to understand how to filter ranges.
<a href=https://support.office.com/en-us/article/video-filter-data-in-a-range-or-table-7fbe34f4-8382-431d-942e-41e9a88f6a96 target=_blank rel=noopener>Here&rsquo;s a dedicated office support page</a>, and <a href=https://www.businessprogrammer.com/libreoffice-calc-advanced-filter/ target=_blank rel=noopener>here&rsquo;s a page explaining some filters in LibreOffice</a>.</p><p>Just look at the amount of steps you need to take just to filter the columns.</p><p>The same search in SQL would be like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#a2f;font-weight:700>SELECT</span><span style=color:#bbb> </span>[<span style=color:#a2f>Date</span>],<span style=color:#bbb> </span>[Info]<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#bbb> </span>[logExample]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>WHERE</span><span style=color:#bbb> </span>[<span style=color:#a2f>date</span>]<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>BETWEEN</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2020-04-02 15:31:34.7320&#39;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2020-04-02 15:31:36.6205&#39;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Adding filter clauses is easy. Say that from such dates, you only want the rows that have <code>requestDuration</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#a2f;font-weight:700>SELECT</span><span style=color:#bbb> </span>[<span style=color:#a2f>Date</span>],<span style=color:#bbb> </span>[Info]<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#bbb> </span>[logExample]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>WHERE</span><span style=color:#bbb> </span>[<span style=color:#a2f>date</span>]<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>BETWEEN</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2020-04-02 15:31:34.7320&#39;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2020-04-02 15:31:36.6205&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span>[RequestDuration]<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>IS</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Or because you know that the <code>RequestDuration</code> is the total time spent on the API for a given request, you want to know the average request duration for <code>GET</code> requests between two dates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#a2f;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>avg</span>(requestDuration)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#bbb> </span>[logExample]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>WHERE</span><span style=color:#bbb> </span>[<span style=color:#a2f>date</span>]<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>BETWEEN</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2020-04-02 15:31:34.7320&#39;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2020-04-02 15:31:36.6205&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span>[RequestDuration]<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>IS</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Started<span style=color:#bbb> </span>executing<span style=color:#bbb> </span>query<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>at</span><span style=color:#bbb> </span>Line<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Msg<span style=color:#bbb> </span><span style=color:#666>8117</span>,<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>Level</span><span style=color:#bbb> </span><span style=color:#666>16</span>,<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>State</span><span style=color:#bbb> </span><span style=color:#666>1</span>,<span style=color:#bbb> </span>Line<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Operand<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>data</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>type</span><span style=color:#bbb> </span><span style=color:#a2f>varchar</span>(<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>is</span><span style=color:#bbb> </span>invalid<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>for</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>avg</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>operator</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>Total<span style=color:#bbb> </span>execution<span style=color:#bbb> </span>time:<span style=color:#bbb> </span><span style=color:#666>00</span>:<span style=color:#666>00</span>:<span style=color:#666>00</span>.<span style=color:#666>001</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Ups&mldr; What&rsquo;s wrong?</p><h2 id=about-the-defaults>About the defaults <a href=#about-the-defaults class=anchor>üîó</a></h2><p>The error above states that <code>the type varchar(max) is invalid for avg operator</code>.
Let&rsquo;s script the table as a create to see what we have.
Remember, this table was created by dbatools due to the <code>AutoCreateTable</code> switch:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#a2f;font-weight:700>CREATE</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span>[dbo].[logExample](<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[<span style=color:#a2f>Date</span>]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[LogLevel]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[<span style=color:#a2f;font-weight:700>Class</span>]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[Url]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[Action]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[<span style=color:#a2f;font-weight:700>Method</span>]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[TraceIdentifier]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[UserIdentity]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[RequestDuration]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span>[Info]<span style=color:#bbb> </span>[<span style=color:#a2f>varchar</span>](<span style=color:#a2f;font-weight:700>max</span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>ON</span><span style=color:#bbb> </span>[<span style=color:#a2f;font-weight:700>PRIMARY</span>]<span style=color:#bbb> </span>TEXTIMAGE_ON<span style=color:#bbb> </span>[<span style=color:#a2f;font-weight:700>PRIMARY</span>]<span style=color:#bbb>
</span></span></span></code></pre></div><p>Ah&mldr; everything is varchar(max).
If you are using this just for quick, simple queries that don&rsquo;t require and specific data type, you can skip this part.</p><p>In our case, we will have to at least change the <code>RequestDuration</code> column to be a <code>BIGINT</code>.
I will also change the userIdentity and you will understand why in a second.
If you want to use this table in long term, I suggest you tune it, by setting the correct data types, indexes and so on.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#a2f;font-weight:700>ALTER</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span>logExample<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>ALTER</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLUMN</span><span style=color:#bbb> </span>RequestDuration<span style=color:#bbb> </span><span style=color:#a2f>BIGINT</span><span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>ALTER</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>TABLE</span><span style=color:#bbb> </span>logExample<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>ALTER</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COLUMN</span><span style=color:#bbb> </span>UserIdentity<span style=color:#bbb> </span><span style=color:#a2f>BIGINT</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>By running this and rerunning the query, we will get the expected result</p><p><p class=markdown-image><img src=/img/dbatools-isn-t-just-for-DBAs/averageTime.png alt=averageTime></p></p><h1 id=final-example---or-a-challenge-if-you-will>Final example - Or a challenge if you will <a href=#final-example---or-a-challenge-if-you-will class=anchor>üîó</a></h1><p>In order to try to make a point again about why I like this SQL > Excel solution so much, let&rsquo;s consider this request</p><blockquote><p>I need to know the name of the user that made the request to the &ldquo;GetUserDetails&rdquo; for the user with id 3. More than that, I need to know how many friends does this user 3 has. All I know is that the request was made between 15:31:34 and 15:31:37</p></blockquote><p>This seems to be a rather specific request, but hopefully you understand the power that you have while querying the database vs Excel/LibreOffice/OpenOffice.</p><p>Let&rsquo;s brake this into parts (and make assumptions for this log file):</p><ul><li>Name of the user that made the request - The <code>UserIdentity</code> column has the id of the user that made the request on the database. The name is stored in the database</li><li>GetUserDetails - It is our <code>Action</code> column</li><li>User with id 3 - This is present in the URL on the request - 3 is the id of the user</li><li>How many friends this user 3 has: The return of the GetUserDetails return a JSON that contains a list of friends</li></ul><h2 id=the-excellibreofficeopenoffice-approach>The Excel/LibreOffice/OpenOffice approach <a href=#the-excellibreofficeopenoffice-approach class=anchor>üîó</a></h2><ol><li>Filter the <code>Date</code> column with a range.</li><li>Filter the <code>Action</code> column to contain only the &ldquo;GetUserDetails&rdquo;</li><li>Filter the <code>URL</code> column to contain only entries for that specific URL (in this case <code>http://localhost/api/users/3/</code>)</li><li>Check the UserIdentity column and go to database and search for that Id</li><li>OPTIONAL: We can filter by RequestDuration being not null because when there&rsquo;s a request duration, it&rsquo;s the response.</li><li>Copy the info column to a text editor, format it as JSON and count the number of friends.</li></ol><h2 id=the-sql-approach>The SQL approach <a href=#the-sql-approach class=anchor>üîó</a></h2><p>We can pretty much apply the filters above, but there are 2 main advantages.
We can perform an <code>INNER JOIN</code> with the user table, and we can convert the <code>Info</code> column, which we know it&rsquo;s a JSON , to a table and count the friends.</p><p>Here&rsquo;s such code:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#a2f;font-weight:700>DECLARE</span><span style=color:#bbb> </span><span style=color:#666>@</span>json<span style=color:#bbb> </span>NVARCHAR(<span style=color:#a2f;font-weight:700>max</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#666>@</span>userName<span style=color:#bbb> </span>NVARCHAR(<span style=color:#666>50</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>SELECT</span><span style=color:#bbb> </span>top<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb> </span><span style=color:#666>@</span>userName<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>appUser.Name,<span style=color:#bbb> </span><span style=color:#666>@</span>json<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>[Info]<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#bbb> </span>logExample<span style=color:#bbb> </span>logEx<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>INNER</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>JOIN</span><span style=color:#bbb> </span>ApplicationUser<span style=color:#bbb> </span>appUser<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#a2f;font-weight:700>ON</span><span style=color:#bbb> </span>logEx.UserIdentity<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>appUser.id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>WHERE</span><span style=color:#bbb> </span>[<span style=color:#a2f>date</span>]<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>BETWEEN</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2020-04-02 15:31:34&#39;</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span><span style=color:#b44>&#39;2020-04-02 15:31:37&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span>[Action]<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;GetUserDetails&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span>[URL]<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#b44>&#39;http://localhost/api/users/3/&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#a2f;font-weight:700>AND</span><span style=color:#bbb> </span>requestDuration<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>IS</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NOT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>NULL</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>DECLARE</span><span style=color:#bbb> </span><span style=color:#666>@</span>totalFriends<span style=color:#bbb> </span><span style=color:#a2f>INT</span><span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#a2f;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>COUNT</span>([<span style=color:#a2f;font-weight:700>key</span>])<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>	</span><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#bbb> </span>OPENJSON(<span style=color:#666>@</span>json,<span style=color:#bbb> </span><span style=color:#b44>&#39;$.friends&#39;</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#a2f;font-weight:700>SELECT</span><span style=color:#bbb> </span><span style=color:#b44>&#39;The request was made by a user named &#39;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#666>@</span>userName<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#b44>&#39;. User 3 has &#39;</span><span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>CAST</span>(<span style=color:#666>@</span>totalFriends<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>AS</span><span style=color:#bbb> </span>nvarchar(<span style=color:#666>10</span>))<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#b44>&#39; friends.&#39;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p><p class=markdown-image><img src=/img/dbatools-isn-t-just-for-DBAs/finalQuery.png alt=finalQuery></p></p><p>Although the SQL code seems more verbose, I still consider it to be better, because you can save the query and re-use it whenever necessary, only having to adjust some parameters.</p><h1 id=conclusion>Conclusion <a href=#conclusion class=anchor>üîó</a></h1><p>This blog post became longer than I anticipated, but the main idea here is not to discuss Excel/LibreOffice/OpenOffice vs SQL.</p><p>3 main points to be highlighted:</p><ul><li>Even if you are not a DBA, you can leverage from dbatools</li><li>If you are not on Windows, or don&rsquo;t feel familiar with the named tools to analyse logs, SQL can be an option (if you read until this point, I assume you are comfortable with SQL).</li><li>Import-DbaCsv combined with SQL Querying can scale pretty easily and (probably) even save you tons of time if you are always looking at the same points.</li></ul><p>Hope that you find this useful, and thanks for reading!</p></div><div class=tags><a href=https://blog.danielssilva.dev/tags/sql>SQL</a>
<a href=https://blog.danielssilva.dev/tags/powershell>PowerShell</a></div><div id=comments><script>var id=5,commentsDiv;if(id){let t="https://github.com/DanielSSilva/blog/issues/".concat(id),n="https://api.github.com/repos/DanielSSilva/blog/issues/".concat(id,"/comments");commentsDiv=document.getElementById("comments");let e=new XMLHttpRequest;e.responseType="json",e.open("GET",n),e.setRequestHeader("Accept","application/vnd.github.v3.html+json"),e.send(),e.onload=function(){if(e.status!=200){let e=document.createElement("p");e.innerHTML="<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>",commentsDiv.appendChild(e)}else{let n=e.response,s=document.createElement("h2");s.innerHTML="Comments: ".concat(n.length),commentsDiv.appendChild(s);let o=document.createElement("p");o.innerHTML="<i>You can leave a comment using this <a href='".concat(t,"'>GitHub issue</a>.</i>"),commentsDiv.appendChild(o),n.forEach(function(e){let t=document.createElement("div");t.setAttribute("class","gh-comment"),t.innerHTML="".concat("<div class='gh-header'>","<img src='",e.user.avatar_url,"' />","<div style='margin:auto 0;'>","<b><a class='gh-username' href='",e.user.html_url,"'>",e.user.login,"</a></b>"," commented at <em>",new Date(e.created_at),"</em>","</div>","</div>","<div class='gh-body'>",e.body_html,"</div>"),commentsDiv.appendChild(t)})}},e.onerror=function(){let e=document.createElement("p");e.innerHTML="<i>Some error loading comments.</i>",commentsDiv.appendChild(e)}}</script></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/DanielSSilva rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#fff"/></g></g></g></svg></a><a class=symbol href=https://twitter.com/DanielSilv9 rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>¬© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Daniel Silva</div></footer></body></html>